<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background: #f1f5f9; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; } 
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 30px; }
        h2 { text-align: center; color: #1e3a8a; margin-bottom: 25px; }
        .section-title { font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 15px; border-left: 5px solid #1e3a8a; padding-left: 10px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 15px; }
        
        label { display: block; font-weight: 600; margin-bottom: 8px; color: #475569; font-size: 0.9rem; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus, select:focus { border-color: #3b82f6; outline: none; }
        
        /* UPLOAD STYLE */
        .file-upload { border: 2px dashed #cbd5e1; padding: 20px; text-align: center; border-radius: 10px; cursor: pointer; transition: 0.3s; background: #f8fafc; color: #1e3a8a; font-weight: bold; }
        .file-upload:hover { border-color: #3b82f6; background: #eff6ff; }
        .preview-img { width: 100%; height: 200px; object-fit: contain; border-radius: 10px; display: none; margin-top: 10px; border: 1px solid #ddd; background: #eee; }

        .btn-submit { width: 100%; padding: 15px; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3); }
        .btn-update { background: linear-gradient(135deg, #f59e0b, #d97706); } 
        .btn-cancel { background: #64748b; margin-top: 10px; display: none; }

        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { background: #f8fafc; text-align: left; padding: 15px; color: #64748b; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        
        .thumb-small { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 1px solid #ddd; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; }
        .badge-heavy { background: #dbeafe; color: #1e40af; }
        .badge-snack { background: #fce7f3; color: #9d174d; }
        .badge-drink { background: #dcfce7; color: #166534; }
        .badge-sweet { background: #ffedd5; color: #9a3412; }

        .action-btns { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-mini { padding: 8px 12px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: white; }
        .btn-edit { background: #f59e0b; }
        .btn-del { background: #ef4444; }
        .btn-offer { background: #10b981; }
        .btn-cancel-offer { background: #6b7280; }
        
        .alert { padding: 15px; border-radius: 10px; margin-top: 20px; display: none; text-align: center; font-weight: 600; background: #dcfce7; color: #166534; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2><i class="fas fa-user-tie"></i> Seller Admin Panel</h2>
        <div class="section-title">üì¶ Input Product</div>
        <input type="hidden" id="editId">
        
        <div class="form-grid">
            <div class="form-group">
                <label>Store Name</label>
                <input type="text" id="sName" placeholder="Contoh: Dapur Bu Dewi">
            </div>
            <div class="form-group">
                <label>WhatsApp Contact</label>
                <input type="text" id="sContact" placeholder="+628xxx">
            </div>
            <div class="form-group">
                <label>Item Name</label>
                <input type="text" id="sItem" placeholder="Contoh: Nasi Goreng Spesial">
            </div>
            <div class="form-group">
                <label>Category</label>
                <select id="sCategory">
                    <option value="" disabled selected>-- Select --</option>
                    <option value="Heavy Meal">üçõ Heavy Meal</option>
                    <option value="Light Snack">üçü Light Snack</option>
                    <option value="Beverage">ü•§ Beverage</option>
                    <option value="Dessert">üç∞ Dessert</option>
                </select>
            </div>
            <div class="form-group">
                <label>Base Price (IDR)</label>
                <input type="number" id="sPrice" placeholder="Contoh: 15000">
            </div>
            <!-- Discount field -->
            <div class="form-group">
                <label>Discount (%)</label>
                <input type="number" id="sDiscount" min="0" max="100" placeholder="0 = no discount">
            </div>
            <div class="form-group">
                <label>Product Photo</label>
                <div class="file-upload" onclick="document.getElementById('sImgInput').click()">
                    <i class="fas fa-cloud-upload-alt"></i> Insert Image
                </div>
                <input type="file" id="sImgInput" style="display:none" accept="image/*" onchange="handleImageUpload()">
                <input type="hidden" id="sImgBase64"> 
            </div>
        </div>

        <img id="imgPreview" class="preview-img" alt="Preview">

        <button id="btnPublish" class="btn-submit" onclick="saveProduct()">
            <i class="fas fa-plus-circle"></i> Add to Catalog
        </button>
        <button id="btnCancel" class="btn-submit btn-cancel" onclick="resetForm()">
            <i class="fas fa-times"></i> Cancel
        </button>

        <div id="msgSuccess" class="alert">‚úÖ Saved Successfully! Image Compressed.</div>
    </div>

    <div class="card">
        <div class="section-title">üìã Live Catalog</div>
        <div class="table-responsive">
            <table id="catalogTable">
                <thead>
                    <tr>
                        <th width="80">Img</th>
                        <th>Item</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="5" style="text-align:center;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyD7FOAqhpJNVq7J6iYBcknOqWdedCIYQvQ",
        authDomain: "kingstenderapp.firebaseapp.com",
        projectId: "kingstenderapp",
        storageBucket: "kingstenderapp.firebasestorage.app",
        messagingSenderId: "264140729392",
        appId: "1:264140729392:web:01064f3b288e653a99d1f5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // IMAGE HANDLING
    function handleImageUpload() {
        const file = document.getElementById('sImgInput').files[0];
        const preview = document.getElementById('imgPreview');
        const hiddenField = document.getElementById('sImgBase64');

        if (!file) return;

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = function (event) {
            const img = new Image();
            img.src = event.target.result;
            
            img.onload = function () {
                const canvas = document.createElement("canvas");
                const MAX_WIDTH = 400;
                const scaleSize = MAX_WIDTH / img.width;
                canvas.width = MAX_WIDTH;
                canvas.height = img.height * scaleSize;

                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

                const srcEncoded = canvas.toDataURL("image/jpeg", 0.6); 
                
                hiddenField.value = srcEncoded;
                preview.src = srcEncoded;
                preview.style.display = "block";
            }
        }
    }

    // READ DATA
    db.collection("products").orderBy("timestamp", "desc").onSnapshot((snapshot) => {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = ""; 

        if(snapshot.empty){
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">No products yet.</td></tr>`;
            return;
        }

        snapshot.forEach((doc) => {
            const d = doc.data();
            const id = doc.id; 
            
            const imgDisplay = d.imageUrl ? `<img src="${d.imageUrl}" class="thumb-small">` : `<div class="thumb-small" style="background:#eee; display:flex; align-items:center; justify-content:center;">No Img</div>`;

            let badge = "badge-heavy";
            if(d.category === "Light Snack") badge = "badge-snack";
            if(d.category === "Beverage") badge = "badge-drink";
            if(d.category === "Dessert") badge = "badge-sweet";

            const hasOffer = d.offer ? true : false;
            const cancelOfferButton = hasOffer ? `<button class="btn-mini btn-cancel-offer" onclick="cancelOffer('${id}')" title="Cancel instant offer"><i class="fas fa-ban"></i></button>` : '';

            const row = `
                <tr>
                    <td>${imgDisplay}</td>
                    <td><b>${d.items[0]}</b><br><small>${d.sellerName}</small></td>
                    <td><span class="badge ${badge}">${d.category}</span></td>
                    <td>Rp ${d.basePrice.toLocaleString()} ${d.discount ? `(-${d.discount}%)` : ''}</td>
                    <td>
                        <div class="action-btns">
                            <button class="btn-mini btn-edit" onclick="editMode('${id}', '${d.sellerName}', '${d.contact}', '${d.items[0]}', '${d.category}', '${d.basePrice}', '${d.discount || 0}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-mini btn-offer" onclick="makeOffer('${id}')" title="Push as instant offer">
                                <i class="fas fa-bolt"></i>
                            </button>
                            ${cancelOfferButton}
                            <button class="btn-mini btn-del" onclick="deleteProduct('${id}', '${d.items[0]}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    });

    // Cancel offer
    function cancelOffer(id) {
        if(confirm('Remove this product from instant offers?')) {
            db.collection("products").doc(id).update({
                offer: firebase.firestore.FieldValue.delete()
            }).then(() => {
                alert('Offer cancelled.');
            }).catch(e => alert('Error: ' + e.message));
        }
    }

    // Make offer
    function makeOffer(id) {
        db.collection("products").doc(id).update({
            offer: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            alert('Product pushed as instant offer!');
        }).catch(e => alert('Error: ' + e.message));
    }

    // SAVE PRODUCT (fixed discount logic)
    function saveProduct() {
        const id = document.getElementById('editId').value;
        const name = document.getElementById('sName').value;
        const contact = document.getElementById('sContact').value;
        const item = document.getElementById('sItem').value;
        const category = document.getElementById('sCategory').value;
        const price = document.getElementById('sPrice').value;
        const discount = document.getElementById('sDiscount').value;
        const imgBase64 = document.getElementById('sImgBase64').value;

        if (!name || !item || !price) return alert("Isi semua data!");
        if (!imgBase64 && !id) return alert("Wajib upload foto!");

        const btn = document.getElementById('btnPublish');
        const originalText = btn.innerHTML;   // store for later restore
        btn.innerHTML = 'Saving...';
        btn.disabled = true;

        const data = {
            sellerName: name,
            contact: contact,
            items: [item],
            category: category,
            basePrice: parseInt(price),
            timestamp: new Date()
        };

        // Handle discount correctly for new vs update
        if (id) {
            // Update mode: use delete if discount is 0 or empty
            if (discount && parseInt(discount) > 0) {
                data.discount = parseInt(discount);
            } else {
                data.discount = firebase.firestore.FieldValue.delete();
            }
        } else {
            // New product: only add discount if >0
            if (discount && parseInt(discount) > 0) {
                data.discount = parseInt(discount);
            }
            // else omit discount field entirely
        }

        if(imgBase64) {
            data.imageUrl = imgBase64;
        }

        if (id) {
            db.collection("products").doc(id).set(data, { merge: true }).then(() => {
                doneSaving();
            }).catch(e => {
                alert("Error: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        } else {
            data.sellerId = "S-" + Date.now();
            db.collection("products").add(data).then(() => {
                doneSaving();
            }).catch(e => {
                alert("Error: " + e.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }
    }

    function deleteProduct(id, name) {
        if(confirm("Hapus " + name + "?")) {
            db.collection("products").doc(id).delete();
        }
    }

    function editMode(id, name, contact, item, category, price, discount) {
        document.getElementById('editId').value = id;
        document.getElementById('sName').value = name;
        document.getElementById('sContact').value = contact;
        document.getElementById('sItem').value = item;
        document.getElementById('sCategory').value = category;
        document.getElementById('sPrice').value = price;
        document.getElementById('sDiscount').value = discount || 0;
        
        document.getElementById('imgPreview').style.display = 'none';
        document.getElementById('sImgBase64').value = ""; 

        const btn = document.getElementById('btnPublish');
        btn.innerHTML = 'Update Product';
        btn.classList.add('btn-update');
        document.getElementById('btnCancel').style.display = 'block';
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('editId').value = "";
        document.getElementById('sItem').value = "";
        document.getElementById('sPrice').value = "";
        document.getElementById('sDiscount').value = "";
        document.getElementById('sImgBase64').value = "";
        document.getElementById('sImgInput').value = "";
        document.getElementById('imgPreview').style.display = 'none';
        
        const btn = document.getElementById('btnPublish');
        btn.innerHTML = '<i class="fas fa-plus-circle"></i> Add to Catalog';
        btn.classList.remove('btn-update');
        document.getElementById('btnCancel').style.display = 'none';
        btn.disabled = false;
    }

    function doneSaving() {
        document.getElementById('msgSuccess').style.display = 'block';
        setTimeout(() => document.getElementById('msgSuccess').style.display = 'none', 3000);
        resetForm();
    }
</script>
</body>
</html>